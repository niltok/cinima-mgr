@page "/Show/Range"
@using cinima_mgr.Data
@using Microsoft.EntityFrameworkCore
@inject StateCache StateCache
@inject NavigationManager NavigationManager
@implements IAsyncDisposable

<div class="container-center">
    <p>
        <label>房间:</label>
        <select class="form-select selector" @onchange="e => SelectRoom(e.Value?.ToString())">
            @foreach (var r in _rooms)
            {
                <option value=@r.Key>@r.Key</option>
            }
        </select>
    </p>
    @if (_room is not null)
    {
        <p>
            <label>场次:</label>
            <select class="form-select" @onchange="e => SelectShow(e.Value.ToString())">
                <option value="" selected=@(_selectedShow == "")>[新建]</option>
                @foreach (var s in _showLabel)
                {
                    <option value=@s.Item1 selected=@(_selectedShow == s.Item1)>@s.Item2</option>
                }
            </select>
            <button class="btn btn-primary" @onclick="Submit">@(_selectedShow == "" ? "添加!" : "保存!")</button>
            <span>@_msg</span>
        </p>
        <p>
            <label>状态:</label>
            <select class="form-select" @bind="_show.Status">
                <option value=0>隐藏</option>
                <option value=1>启用</option>
                <option value=2>取消</option>
            </select>
        </p>
        <p>
            <label>基准价格:</label>
            <input class="form-control" type="number" @bind="_show.BasePrice" min="0" step="0.01"/>
        </p>
        <p>
            <label>放映时间:</label>
            <input class="form-control" type="datetime-local" @bind="_show.Time"/>
            <span> ~ @((_show.Time + _show.Movie.Duration).ToString("HH:mm"))</span>
        </p>
        <p>
            <label>可购买时间:</label>
            <input class="form-control" type="datetime-local" @bind="_show.CanBuyAfter"/>
            <q class="small">状态为启用时未到时间不可购买</q>
        </p>
        <p>
            <MoviePicker Movies="_movies" @bind-Movie="_show.Movie"/>
        </p>
        <p>
            <button @onclick="ResetState" class="btn btn-secondary">重置可用座位至房间状态</button>
            <button @onclick="FilterSkip" class="btn btn-secondary">选择间隔座位（疫情专用）</button>
        </p>
        <p>
            <div style="width: 100%">
                <SitPicker @bind-PosState="_show.PosState" Height="_room.Height" Width="_room.Width" Dev="true"/>
            </div>
        </p>
    }
</div>

@code {
    MgrContext _db;
    string _msg = "";

    Dictionary<string, RoomTemplate> _rooms = new();
    RoomTemplate? _room;

    Dictionary<string, Show> _shows = new();
    string _selectedShow = "";
    Show _show = new ();
    List<(string, string)> _showLabel = new();

    List<Movie> _movies = new();
    readonly string[] _statusLabel = {"[已隐藏]", "", "[已取消]"};

    void LoadLabel()
    {
        _showLabel = _room.Shows.Where(s => s.Time > DateTime.Now)
            .OrderByDescending(s => s.Time).Select(s =>
        {
            var st = s.Time.ToString("yyyy-MM-dd HH:mm");
            var et = (s.Time + s.Movie.Duration).ToString("HH:mm");
            return (s.Id, $"{st} ~ {et} {_statusLabel[s.Status]}");
        }).ToList();
    }
    
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        
        if (StateCache.User is null || !StateCache.User.IsMgr)
        {
            NavigationManager.NavigateTo("");
            return;
        }

        _db = new MgrContext();
        _movies = await _db.Movies
            .Include(m => m.Shows)
            .OrderByDescending(m => m.ReleaseDate)
            .ToListAsync();
        _rooms = await _db.RoomTemplates
            .Where(r => r.Status == 1)
            .Include(r => r.Shows)
            .ToDictionaryAsync(r => r.Name);
        if (_rooms.Count > 0)
        {
            _room = _rooms.First().Value;
            _show.PosState = _room.PosState;
            await Task.WhenAll(_room.Shows.Select(s => 
                _db.Entry(s).Reference(s => s.Movie).LoadAsync()));
            _shows = _room.Shows.ToDictionary(s => s.Id);
            LoadLabel();
            _show = new Show
            {
                Id = Guid.NewGuid().ToString(),
                Time = DateTime.Now,
                PosState = _room.PosState,
                Room = _room,
                Movie = _movies.First(),
                BasePrice = 0,
                CanBuyAfter = DateTime.Now,
                Status = 0
            };
        }
    }

    void ResetState()
    {
        _show.PosState = _room.PosState;
    }

    void SelectRoom(string? s)
    {
        _room = _rooms.ContainsKey(s) ? _rooms[s] : null;
        _shows = _room.Shows.ToDictionary(s => s.Id);
        LoadLabel();
        _selectedShow = "";
        _show = new Show
        {
            Id = Guid.NewGuid().ToString(),
            Time = DateTime.Now,
            PosState = _room.PosState,
            Room = _room,
            Movie = _movies.First(),
            BasePrice = 0,
            CanBuyAfter = DateTime.Now,
            Status = 0
        };
    }

    async Task SelectShow(string s)
    {
        if (_selectedShow != "") await _db.Entry(_show).ReloadAsync();
        _selectedShow = s;
        _show = s != "" ? _shows[s] : new Show
        {
            Id = Guid.NewGuid().ToString(),
            Time = DateTime.Now,
            PosState = _room.PosState,
            Room = _room,
            Movie = _movies.First(),
            BasePrice = 0,
            CanBuyAfter = DateTime.Now,
            Status = 0
        };
    }

    async Task Submit()
    {
        try
        {
            var conflict = _room.Shows.FirstOrDefault(s => !(s == _show || 
                                                             s.Time + s.Movie.Duration < _show.Time || 
                                                             _show.Time + _show.Movie.Duration < s.Time));
            if (conflict is not null)
            {
                var st = conflict.Time.ToString("yyyy-MM-dd HH:mm");
                var et = (conflict.Time + conflict.Movie.Duration).ToString("HH:mm");
                _msg = $"时间冲突 {st} ~ {et}";
                return;
            }
            if (_selectedShow == "")
            {
                _show.Movie.Shows.Add(_show);
            }
            await _db.SaveChangesAsync();
            await _db.Entry(_room).ReloadAsync();
            await Task.WhenAll(_room.Shows.Select(s => 
                _db.Entry(s).Reference(s => s.Movie).LoadAsync()));
            _shows = _room.Shows.ToDictionary(s => s.Id);
            LoadLabel();
            _msg = (_selectedShow == "" ? "添加" : "保存") + "成功 " + DateTime.Now.ToString("HH:mm:ss");
            _selectedShow = _show.Id;
        }
        catch (Exception ex)
        {
            _msg = ex.Message;
            throw;
        }
    }

    private void FilterSkip()
    {
        _show.PosState = PosStateHelper.FilterSkip1(_show.PosState, _room.Height, _room.Width);
    }

    public async ValueTask DisposeAsync()
    {
        await _db.DisposeAsync();
    }

}
