@page "/refund"
@using System.Text.Json
@using cinima_mgr.Ali
@using cinima_mgr.Data

@if (_poserror) { <MsgBox Msg="@resu" OnClosed="() => _poserror = false"></MsgBox> }

@code {
    private MarkupString convertedMarkdown;
    [Parameter]
    public bool Enable { get; set; } = false;
    [Parameter]
    public string out_trade_no { get; set; }
    public string price { get; set; }
    public string resu;
    public bool _poserror = false;
    protected override void OnParametersSet()
    {
        if (!Enable) return;
        AlipayConfig m = new AlipayConfig();
        string res = m.Refund(out_trade_no, price);
        string jsonString = m.RefundQuery(out_trade_no);

        int n = 0, v = 0;
        using(JsonDocument document = JsonDocument.Parse(jsonString))
        {
            JsonElement root = document.RootElement;
            JsonElement Element = root.GetProperty("alipay_trade_fastpay_refund_query_response");

            foreach(JsonProperty element in Element.EnumerateObject())
            {
                if (element.Name == "refund_status")
                {
                    n = 1;
                    if(element.Value.GetString() == "REFUND_SUCCESS")
                    {
                        v = 1;
                        Console.WriteLine("退款成功!"); 
                    }
                    else
                    {
                        v = -1;
                        Console.WriteLine("退款失败!");
                    }
                }
                else
                {
                    continue;
                }

            }
            if(n == 1 && v == 1)
            {
                resu = "退款成功!";
                changedb();
                _poserror = true;
            }
            else
            {
                resu = "退款失败!";
                _poserror = true;
            }
        }
    }
    
    async Task changedb()
    {
        await using var db = new MgrContext();
        var data = await db.Orders
            .Where(t => t.Id == out_trade_no).SingleOrDefaultAsync();
        if(data.State == null)
        {
            Console.WriteLine("订单不存在");
        }
        else
        {
            //设置订单信息：已退款
            data.State = 2;
        }
    }
}
    
    

